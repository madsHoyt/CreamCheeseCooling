<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cream Cheese Cooling Time Calculator</title>
        <!-- Load Tailwind CSS for styling -->
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Custom font and base styling */
            body {
                font-family: "Inter", sans-serif;
                background-color: #f7f7f7;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                padding: 2rem 1rem;
            }
            .container {
                max-width: 900px; /* Slightly wider container for more inputs */
                width: 100%;
            }
            input[type="number"] {
                transition: all 0.15s ease-in-out;
            }
        </style>
    </head>
    <body>
        <div class="container bg-white shadow-2xl rounded-xl p-8 space-y-8">
            <header class="text-center pb-4 border-b border-gray-100">
                <h1 class="text-4xl font-extrabold text-blue-800">
                    Blast Chiller Time Predictor
                </h1>
                <p class="text-gray-600 mt-2">
                    Adjust physical properties below to refine the cooling
                    model.
                </p>
            </header>

            <!-- Input and Output Section -->
            <section class="grid md:grid-cols-2 gap-8">
                <!-- Ambient Temp Input Card -->
                <div
                    class="bg-gray-50 p-6 rounded-lg shadow-inner flex flex-col justify-between"
                >
                    <div>
                        <h2
                            class="text-2xl font-semibold mb-4 text-blue-700 border-b pb-2"
                        >
                            Adjust Ambient Temperature
                        </h2>

                        <label
                            for="ambientTempF"
                            class="block text-lg font-medium text-gray-700 mb-2"
                        >
                            Ambient Cooler Temperature ($T_\infty$)
                        </label>
                        <div class="flex items-center space-x-2">
                            <input
                                type="number"
                                id="ambientTempF"
                                value="32"
                                min="-450"
                                max="100"
                                step="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-2xl font-bold text-center"
                            />
                            <span class="text-xl font-bold text-gray-500"
                                >&deg;F</span
                            >
                        </div>
                    </div>
                    <p
                        id="freeze-warning"
                        class="mt-4 p-3 text-sm font-medium rounded-lg hidden"
                    ></p>
                </div>

                <!-- Output Card -->
                <div
                    class="p-6 bg-white rounded-lg shadow-lg border border-blue-100"
                >
                    <h2
                        class="text-2xl font-semibold mb-4 text-blue-700 border-b pb-2"
                    >
                        Predicted Results
                    </h2>

                    <div class="space-y-4">
                        <div
                            class="flex justify-between items-center p-3 bg-blue-50 rounded-lg"
                        >
                            <span class="text-gray-700 font-medium text-lg"
                                >Time to Target Core Temp (45°F):</span
                            >
                            <span
                                id="resultTime"
                                class="text-3xl font-extrabold text-blue-800"
                                >--</span
                            >
                        </div>

                        <div
                            class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200"
                        >
                            <span class="text-red-700 font-medium text-lg"
                                >Time to Surface Freezing (30°F):</span
                            >
                            <span
                                id="freezeTime"
                                class="text-2xl font-extrabold text-red-800"
                                >--</span
                            >
                        </div>

                        <div class="grid grid-cols-2 gap-4 pt-2 text-sm">
                            <div>
                                <span class="text-gray-600 block"
                                    >Core Temp Ratio ($\Theta_c$):</span
                                >
                                <span id="ratio" class="font-mono text-gray-800"
                                    >--</span
                                >
                            </div>
                            <div>
                                <span class="text-gray-600 block"
                                    >Surface Freeze Ratio ($\Theta_s$):</span
                                >
                                <span
                                    id="freezeRatio"
                                    class="font-mono text-gray-800"
                                    >--</span
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Model Calibration and Assumptions - NOW EDITABLE -->
            <section class="pt-6 border-t border-gray-100">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">
                    Model Parameters (Editable)
                </h2>
                <div class="grid md:grid-cols-3 gap-6 text-sm">
                    <!-- Column 1: Temperature Targets -->
                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                        <h3 class="font-bold text-blue-600 border-b pb-1">
                            Temperature Conditions
                        </h3>

                        <div>
                            <label
                                for="tInitialF"
                                class="block font-medium text-gray-700"
                                >Start Temp ($T_i$, °F)</label
                            >
                            <input
                                type="number"
                                id="tInitialF"
                                value="165"
                                step="0.1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>

                        <div>
                            <label
                                for="tTargetF"
                                class="block font-medium text-gray-700"
                                >Target Core Temp ($T_c$, °F)</label
                            >
                            <input
                                type="number"
                                id="tTargetF"
                                value="45"
                                step="0.1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>

                        <div>
                            <label
                                for="tFreezeF"
                                class="block font-medium text-gray-700"
                                >Freezing Point ($T_f$, °F)</label
                            >
                            <input
                                type="number"
                                id="tFreezeF"
                                value="30"
                                step="0.1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>
                    </div>

                    <!-- Column 2: Dimensions & Calibrated Resistance -->
                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                        <h3 class="font-bold text-blue-600 border-b pb-1">
                            Box Geometry & Resistance
                        </h3>

                        <div>
                            <label
                                for="LxIn"
                                class="block font-medium text-gray-700"
                                >Box Length ($L_x$, in)</label
                            >
                            <input
                                type="number"
                                id="LxIn"
                                value="15.5"
                                step="0.1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>
                        <div>
                            <label
                                for="LyIn"
                                class="block font-medium text-gray-700"
                                >Box Width ($L_y$, in)</label
                            >
                            <input
                                type="number"
                                id="LyIn"
                                value="11.0"
                                step="0.1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>
                        <div>
                            <label
                                for="LzIn"
                                class="block font-medium text-gray-700"
                                >Box Height ($L_z$, in)</label
                            >
                            <input
                                type="number"
                                id="LzIn"
                                value="6.5"
                                step="0.1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>

                        <div class="pt-2">
                            <label
                                for="biotCalibrated"
                                class="block font-medium text-gray-700"
                                >Effective Biot Number ($\text{Bi}$)</label
                            >
                            <input
                                type="number"
                                id="biotCalibrated"
                                value="0.75"
                                step="0.01"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                Calibrated to 47h at 32°F.
                            </p>
                        </div>
                    </div>

                    <!-- Column 3: Material Properties -->
                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                        <h3 class="font-bold text-blue-600 border-b pb-1">
                            Material Properties
                        </h3>

                        <div>
                            <label
                                for="cpJkgk"
                                class="block font-medium text-gray-700"
                                >Specific Heat ($c_p$, J/kg$\cdot$K)</label
                            >
                            <input
                                type="number"
                                id="cpJkgk"
                                value="3114"
                                step="1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>

                        <div>
                            <label
                                for="rhoKgM3"
                                class="block font-medium text-gray-700"
                                >Density ($\rho$, kg/m$^3$)</label
                            >
                            <input
                                type="number"
                                id="rhoKgM3"
                                value="750"
                                step="1"
                                class="w-full px-3 py-1 border border-gray-300 rounded-md mt-1 text-base input-param"
                            />
                        </div>

                        <div class="pt-2">
                            <label class="block font-medium text-gray-700"
                                >Thermal Conductivity ($k$, W/m$\cdot$K)</label
                            >
                            <p class="text-base font-semibold text-gray-800">
                                0.4 (Fixed)
                            </p>
                            <p class="text-xs text-gray-500">
                                Based on composition.
                            </p>
                        </div>

                        <div class="pt-2">
                            <h3 class="font-bold text-blue-600 border-b pb-1">
                                Derived Constant
                            </h3>
                            <p class="text-xs text-gray-500">
                                Thermal Diffusivity Constant
                                $\left(\frac{k}{\rho \cdot c_p \cdot
                                L^2}\right)$
                            </p>
                            <span
                                id="derivedConstant"
                                class="text-xs font-mono text-gray-800"
                                >--</span
                            >
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <script>
            // --- FIXED CONSTANTS ---
            const K_CC_W_M_K = 0.4; // Thermal Conductivity of cream cheese (W/m*K) - Kept fixed

            // --- UTILITY FUNCTIONS ---

            /** Converts Fahrenheit to Celsius. */
            function fahrenheitToCelsius(f) {
                return ((f - 32) * 5) / 9;
            }

            /** Converts Inches to Meters. */
            function inchesToMeters(inches) {
                return inches * 0.0254;
            }

            /** Solves the transcendental equation for eigenvalues (lambda_1) for a plane wall. */
            function solveEigenvalue(Bi) {
                if (Bi === 0) return 0;
                if (Bi > 100) return Math.PI / 2;

                let lambda = Math.atan(Bi);
                let prevLambda = 0;
                let tolerance = 1e-6;
                let iteration = 0;

                // Newton-Raphson Iteration
                while (
                    Math.abs(lambda - prevLambda) > tolerance &&
                    iteration < 50
                ) {
                    prevLambda = lambda;
                    let f = lambda * Math.tan(lambda) - Bi;
                    let df =
                        Math.tan(lambda) +
                        lambda / (Math.cos(lambda) * Math.cos(lambda));
                    lambda = lambda - f / df;
                    iteration++;
                }
                return lambda;
            }

            /** * Calculates the required Fourier number (Fo) based on the temperature ratio, Biot number,
             * and location (x/L).
             * @param {number} thetaRatio - The dimensionless temperature ratio (Theta).
             * @param {number} Bi - The Biot Number.
             * @param {number} xL - Location as a fraction of characteristic length (0=center, 1=surface).
             * @returns {number} The required Fourier number.
             */
            function calculateFoAtLocation(thetaRatio, Bi, xL) {
                const lambda1 = solveEigenvalue(Bi);

                // C_1 constant for plane wall
                const c1 =
                    (4 * Math.sin(lambda1)) /
                    (2 * lambda1 + Math.sin(2 * lambda1));

                // Full transient equation at location x/L: Theta = C1 * exp(-lambda1^2 * Fo) * cos(lambda1 * x/L)
                const spatialFactor = c1 * Math.cos(lambda1 * xL);

                if (thetaRatio <= 0 || spatialFactor <= 0) {
                    return Infinity;
                }

                // Fo = -ln(Theta / (C1 * cos(lambda1 * x/L))) / lambda1^2
                const foRequired =
                    -Math.log(thetaRatio / spatialFactor) / (lambda1 * lambda1);

                return foRequired;
            }

            /** Main function to calculate and display the cooling and freezing times. */
            function calculateCoolingTime() {
                // --- READ DYNAMIC INPUTS ---
                const ambientTempF = parseFloat(
                    document.getElementById("ambientTempF").value
                );
                const tInitialF = parseFloat(
                    document.getElementById("tInitialF").value
                );
                const tTargetF = parseFloat(
                    document.getElementById("tTargetF").value
                );
                const tFreezeF = parseFloat(
                    document.getElementById("tFreezeF").value
                );

                const LxIn = parseFloat(document.getElementById("LxIn").value);
                const LyIn = parseFloat(document.getElementById("LyIn").value);
                const LzIn = parseFloat(document.getElementById("LzIn").value);

                const biotCalibrated = parseFloat(
                    document.getElementById("biotCalibrated").value
                );
                const cpJkgk = parseFloat(
                    document.getElementById("cpJkgk").value
                );
                const rhoKgM3 = parseFloat(
                    document.getElementById("rhoKgM3").value
                );

                // Basic validation check (ambientTempF check removed as per request)
                if (
                    isNaN(ambientTempF) ||
                    isNaN(tInitialF) ||
                    isNaN(tTargetF) ||
                    isNaN(tFreezeF) ||
                    isNaN(LxIn) ||
                    isNaN(LyIn) ||
                    isNaN(LzIn) ||
                    isNaN(biotCalibrated) ||
                    isNaN(cpJkgk) ||
                    isNaN(rhoKgM3) ||
                    cpJkgk <= 0 ||
                    rhoKgM3 <= 0 ||
                    tTargetF >= tInitialF
                ) {
                    document.getElementById("resultTime").textContent =
                        "Input Error";
                    document.getElementById("freezeTime").textContent = "--";
                    document.getElementById("ratio").textContent = "--";
                    document.getElementById("freezeRatio").textContent = "--";
                    document.getElementById("derivedConstant").textContent =
                        "Invalid inputs prevent calculation.";
                    return;
                }

                // --- CALCULATE DERIVED GEOMETRY ---
                // Characteristic length (L) is half the shortest dimension
                const L_Z_M = inchesToMeters(Math.min(LxIn, LyIn, LzIn));
                const L_CHARACTERISTIC = L_Z_M / 2;

                // --- CALCULATE FOURIER CONSTANT ---
                // FO_CONST = k / (rho * cp * L^2)
                const FO_CONST_PER_S =
                    K_CC_W_M_K /
                    (rhoKgM3 * cpJkgk * (L_CHARACTERISTIC * L_CHARACTERISTIC));

                document.getElementById(
                    "derivedConstant"
                ).textContent = `${FO_CONST_PER_S.toExponential(
                    4
                )} s⁻¹ (Shortest side L: ${L_CHARACTERISTIC.toFixed(4)} m)`;

                // --- FREEZE WARNING LOGIC ---
                const freezeWarning = document.getElementById("freeze-warning");
                const ambientInput = document.getElementById("ambientTempF");
                if (ambientTempF < tFreezeF) {
                    freezeWarning.classList.remove(
                        "hidden",
                        "bg-yellow-100",
                        "text-yellow-700"
                    );
                    freezeWarning.classList.add("bg-red-100", "text-red-700");
                    freezeWarning.textContent = `CRITICAL WARNING: Ambient temp (${ambientTempF}°F) is below freezing point (${tFreezeF}°F). Surface will freeze! (Model may overestimate speed due to latent heat neglect)`;
                    ambientInput.classList.add("border-red-500", "bg-red-50");
                } else if (ambientTempF <= tFreezeF + 5) {
                    // Warning margin
                    freezeWarning.classList.remove(
                        "hidden",
                        "bg-red-100",
                        "text-red-700"
                    );
                    freezeWarning.classList.add(
                        "bg-yellow-100",
                        "text-yellow-700"
                    );
                    freezeWarning.textContent = `CAUTION: Ambient temp (${ambientTempF}°F) is very close to freezing. Ensure tight temperature control.`;
                    ambientInput.classList.remove(
                        "border-red-500",
                        "bg-red-50"
                    );
                } else {
                    freezeWarning.classList.add("hidden");
                    ambientInput.classList.remove(
                        "border-red-500",
                        "bg-red-50"
                    );
                }

                // --- CORE COOLING CALCULATION (x/L = 0) ---

                // 1. Convert Temps to Celsius
                const T_ambient_C = fahrenheitToCelsius(ambientTempF);
                const T_INITIAL_C = fahrenheitToCelsius(tInitialF);
                const T_TARGET_C = fahrenheitToCelsius(tTargetF);

                // 2. Calculate Core Temperature Ratio (Theta_c at x/L=0)
                const ratioCore =
                    (T_TARGET_C - T_ambient_C) / (T_INITIAL_C - T_ambient_C);

                if (ratioCore <= 0) {
                    document.getElementById("resultTime").textContent =
                        "INSTANT (Error)";
                    document.getElementById("ratio").textContent = "0";
                } else {
                    // 3. Calculate Required Fourier Number for Core
                    const foRequiredCore = calculateFoAtLocation(
                        ratioCore,
                        biotCalibrated,
                        0
                    );

                    // 4. Calculate Time
                    const timeSecondsCore = foRequiredCore / FO_CONST_PER_S;
                    const timeHoursCore = timeSecondsCore / 3600;

                    // 5. Update UI
                    document.getElementById("ratio").textContent =
                        ratioCore.toFixed(4);
                    document.getElementById(
                        "resultTime"
                    ).textContent = `${timeHoursCore.toFixed(1)} hrs`;
                }

                // --- SURFACE FREEZING CALCULATION (x/L = 1) ---
                const T_FREEZE_C = fahrenheitToCelsius(tFreezeF);

                if (ambientTempF >= tFreezeF) {
                    // Freezing is impossible if the air temp is not below the freezing point
                    document.getElementById("freezeTime").textContent = "NEVER";
                    document.getElementById("freezeRatio").textContent = "--";
                } else {
                    // 1. Calculate Surface Freezing Ratio (Theta_s at x/L=1)
                    const ratioFreeze =
                        (T_FREEZE_C - T_ambient_C) /
                        (T_INITIAL_C - T_ambient_C);

                    // 2. Calculate Required Fourier Number for Surface
                    const foRequiredFreeze = calculateFoAtLocation(
                        ratioFreeze,
                        biotCalibrated,
                        1
                    ); // x/L = 1 for surface

                    // 3. Calculate Time
                    const timeSecondsFreeze = foRequiredFreeze / FO_CONST_PER_S;
                    const timeHoursFreeze = timeSecondsFreeze / 3600;

                    // 4. Update UI
                    document.getElementById("freezeRatio").textContent =
                        ratioFreeze.toFixed(4);
                    document.getElementById(
                        "freezeTime"
                    ).textContent = `${timeHoursFreeze.toFixed(1)} hrs`;
                }
            }

            // --- EVENT LISTENERS ---

            // Array of all elements that trigger a recalculation
            const inputElements = [
                "ambientTempF",
                "tInitialF",
                "tTargetF",
                "tFreezeF",
                "LxIn",
                "LyIn",
                "LzIn",
                "biotCalibrated",
                "cpJkgk",
                "rhoKgM3",
            ];

            inputElements.forEach((id) => {
                document
                    .getElementById(id)
                    .addEventListener("input", calculateCoolingTime);
            });

            // Run initial calculation on load
            window.onload = function () {
                calculateCoolingTime();
            };
        </script>
    </body>
</html>
